## План валидации и рефакторинга Product Visor

Актуализировано на основе `documents/common-rules.md`, архитектурной документации и быстрого аудита фронтенда.

### Приоритеты

- P1 — критично/быстро
- P2 — важно
- P3 — улучшения

### P1. Фронтенд: унификация HTTP-слоя и конфигурации

- Перевести все обращения к API на единый клиент:
  - Убрать прямой `fetch` и прямой `axios` из модулей, использовать общий `httpClient`/`microservicesHttpClient` с перехватчиками.
  - Привести `AuthContext.jsx` и `authService.js` к единому способу логина.
- Конфигурация микросервисов:
  - Убрать жёстко прописанные IP из `src/config/api-config.js`.
  - Dev: относительные пути + Vite proxy для `order-service`, `ozon-service`, `yandex-service`, `client`, `auth`.
  - Prod: базовые URL через ENV (`VITE_API_PV_BACKEND`, `VITE_API_AUTH`, `VITE_API_CLIENT`, ...).
- Токен/контекст компании:
  - Централизовать восстановление `authToken` и `companyId` из `localStorage` в слое HTTP при старте.
  - Единый метод `clearSession()` при 401: очистка состояния и принудительный редирект на `/login`.

### P1. Безопасность и контекст (backend)

- Зафиксировать стандарт заголовка компании: `X-Company-Id` (единое имя в коде и документации).
- Контроллеры: извлекать `ownerUserId` и эффективный `companyId` через `JwtUtil.getRequiredOwnerId()` и проверять принадлежность сущностей каждой операции.

### P2. Backend-слои, DTO и маппинг

- Гарантировать, что контроллеры не содержат бизнес-логики и не отдают сущности; только DTO.
- Проверить наличие и полноту MapStruct-мапперов на каждую сущность, использовать `@AfterMapping` для обратных ссылок.
- Сервисы должны инкапсулировать генерацию уникальных значений (например, артикул).

### P2. Flyway и схемы БД

- Именование миграций: строгий формат `Vx__description.sql` в каждом модуле.
- Исключить ручные изменения схемы вне миграций.
- Синхронизировать схемы с документацией (`MICROSERVICES_SETUP.md`).

### P2. Интеграции, события, Kafka

- Централизовать конфигурацию HTTP клиентов (Feign/WebClient) и retry/timeout-политику.
- Сверить Kafka-топики с `MICROSERVICES_INTERACTION_MAP.md`, вынести константы топиков в общий модуль (`common-core`).
- Подтвердить EDA для `order-service`: публикация/слушатели событий, пул потоков, idempotency.

### P2. Документация ↔ код

- Сверить фактические endpoints и порты в каждом сервисе с `documents/*-service.md` и обновить расхождения (или код, или документы).
- Добавить раздел «Security & Context» в документы сервисов: используемые заголовки, обязательные проверки.

### P3. Логирование и метрики

- Нормализовать уровни логов (ERROR/WARN/INFO/DEBUG/TRACE) и убрать избыточные логи в проде.
- Добавить/проверить Prometheus-метрики и health-пробы, где отсутствуют.

### P3. Тестируемость и стиль

- Юнит-тесты бизнес-логики сервисов и тесты перехватчиков HTTP на фронте.
- Проверка стиля: осмысленные имена, отсутствие сокращений, единая структура модулей.

### Быстрые правки (рекомендуется начать с них)

1) `src/config/api-config.js`
   - Заменить IP на `import.meta.env.VITE_*`.
   - Для dev — пустые `BASE_URL` и прокси в `vite.config.js` (как в документации), для prod — читать `VITE_API_*`.

2) `AuthContext.jsx` и `src/services/authService.js`
   - Оставить одну реализацию логина (axios через общий клиент), единый формат параметров.
   - Client credentials вынести в конфиг/ENV при необходимости (OAuth2 flow из `AUTHENTICATION_SETUP.md`).

3) `src/utils/http-client.js`
   - Инициализировать состояние из `localStorage` на старте.
   - Ввести `DEBUG_HTTP` (из ENV) для логов запросов/ответов.
   - Добавить `clearSession()` и использовать его в обработке 401.

### Чек-лист валидации перед началом рефакторинга

- Окончательно подтвердить: требуется ли `client_id/client_secret` при логине, или достаточно `username/password`.
- Подтвердить стандарт заголовка компании: `X-Company-Id`.
- Уточнить перечень прод-URL для `VITE_API_*`.

---

После подтверждения пунктов чек-листа начинаем с блока P1 (конфиг и HTTP-слой), затем бэкенд-валидация безопасности и слоёв, далее P2/P3.


