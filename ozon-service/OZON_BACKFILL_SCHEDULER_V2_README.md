# OzonBackfillSchedulerV2 - Улучшенная версия планировщика синхронизации

## Обзор

`OzonBackfillSchedulerV2` - это полностью переписанная версия оригинального `OzonBackfillScheduler` с применением современных практик программирования. Класс сохраняет всю функциональность оригинала, но значительно улучшает архитектуру, производительность и поддерживаемость.

## Основные улучшения

### 1. Асинхронная обработка
- **Параллельная обработка компаний**: Использование `CompletableFuture` для одновременной синхронизации нескольких компаний
- **Настраиваемый пул потоков**: Фиксированный пул из 3 потоков для контроля ресурсов
- **Конфигурируемая асинхронность**: Возможность отключения асинхронной обработки через `app.sync.async-enabled`

### 2. Улучшенная архитектура
- **Разделение ответственности**: Выделение вспомогательных методов и внутренних классов
- **Функциональные интерфейсы**: Использование `CompanySyncFunction` для гибкости
- **Автоматическое управление ресурсами**: Класс `CompanyContext` с `AutoCloseable`

### 3. Конфигурируемость
```yaml
app:
  sync:
    enabled: true
    async-enabled: true
    checkpoint-name: FBO_ORDERS
    max-gap-minutes: 1
    initial-delay-ms: 10000
    periodic-interval-ms: 120000
    batch-size: 1000
    initial-sync-days: 180
```

### 4. Улучшенная обработка ошибок
- **Кастомные исключения**: Класс `SyncException` для специфичных ошибок синхронизации
- **Детальное логирование**: Структурированные логи с эмодзи для лучшей читаемости
- **Graceful degradation**: Продолжение работы при ошибках отдельных компаний

### 5. Метрики и мониторинг
- **Класс `SyncMetrics`**: Автоматический подсчет времени выполнения
- **Детальная статистика**: Количество обработанных заказов, время выполнения
- **Улучшенные логи**: Подробная информация о каждом этапе синхронизации

### 6. Безопасность и надежность
- **Try-with-resources**: Автоматическая очистка контекста компании
- **Транзакционность**: Правильное управление транзакциями
- **Изоляция ошибок**: Ошибки одной компании не влияют на другие

## Внутренние классы

### CompanyContext
Автоматически управляет контекстом компании:
```java
try (CompanyContext context = new CompanyContext(company)) {
    // Работа в контексте компании
    // Автоматическая очистка при выходе
}
```

### SyncMetrics
Отслеживает производительность синхронизации:
```java
SyncMetrics metrics = new SyncMetrics();
// ... выполнение синхронизации ...
long duration = metrics.getDuration();
```

### SyncException
Специализированное исключение для ошибок синхронизации:
```java
throw new SyncException("Initial sync failed for company " + companyId, e);
```

## Конфигурация

### Основные параметры
- `app.sync.enabled` - включение/выключение сервиса синхронизации
- `app.sync.async-enabled` - включение асинхронной обработки
- `app.sync.max-gap-minutes` - максимальный разрыв в минутах для автоматической синхронизации
- `app.sync.batch-size` - размер пакета для обработки заказов
- `app.sync.initial-sync-days` - количество дней для начальной синхронизации

### Временные параметры
- `app.sync.initial-delay-ms` - задержка перед первым запуском (10 секунд)
- `app.sync.periodic-interval-ms` - интервал периодической проверки (2 минуты)

## Использование

### Автоматический запуск
Класс автоматически запускается при старте приложения и выполняет периодические проверки.

### Ручное управление
```java
@Autowired
private OzonBackfillSchedulerV2 scheduler;

// Принудительная синхронизация всех компаний
scheduler.forceSyncAllCompanies();

// Получение информации о синхронизации
Optional<SyncCheckpoint> info = scheduler.getLastSyncInfo();
```

## Миграция с V1

1. **Замена зависимостей**: Обновите `@Autowired` инъекции на новый класс
2. **Обновление конфигурации**: Добавьте новые параметры в `application.yml`
3. **Тестирование**: Проверьте работу в тестовой среде
4. **Мониторинг**: Следите за логами и метриками

## Преимущества перед V1

| Аспект | V1 | V2 |
|--------|----|----|
| Производительность | Последовательная обработка | Параллельная обработка |
| Конфигурируемость | Жестко заданные параметры | Гибкая конфигурация |
| Обработка ошибок | Базовая | Продвинутая с кастомными исключениями |
| Архитектура | Монолитная | Модульная с разделением ответственности |
| Логирование | Простое | Структурированное с эмодзи |
| Ресурсы | Ручное управление | Автоматическое управление |
| Тестируемость | Сложная | Упрощенная благодаря модульности |

## Рекомендации по использованию

1. **Настройте пул потоков** в зависимости от количества компаний и ресурсов сервера
2. **Мониторьте логи** для выявления проблем с синхронизацией
3. **Используйте метрики** для оптимизации производительности
4. **Тестируйте конфигурацию** перед развертыванием в продакшн
5. **Настройте алерты** на основе логов и метрик
